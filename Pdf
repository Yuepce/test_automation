import os
from spire.pdf import PdfDocument, PdfComparer, PdfBrushes, PdfTrueTypeFont, PdfSolidBrush, PdfStringFormat, PdfTextAlignment
from spire.pdf.graphics import PdfRGBColor, PdfPen, PdfPageBase, PdfFontStyle
from spire.pdf.common import SizeF, PointF, RectangleF

# Input files
pdf_a_path = '20250918115113_Z0N613_E60043126_FNA.pdf'
pdf_b_path = '20250918115113_Z0N613_E60043126_FNA - Copy.pdf'

# Output folder setup
output_dir = "output"
os.makedirs(output_dir, exist_ok=True)
output_path = os.path.join(output_dir, "CompareResult.pdf")

# Load both PDFs
pdf_a = PdfDocument(pdf_a_path)
pdf_b = PdfDocument(pdf_b_path)

# Compare PDFs
comparer = PdfComparer(pdf_a, pdf_b)
comparer.Compare(output_path)

# Dispose the input documents
pdf_a.Dispose()
pdf_b.Dispose()

# Now open the generated comparison result to add report boxes
result_doc = PdfDocument()
result_doc.LoadFromFile(output_path)

# Font & style setup
font = PdfTrueTypeFont("Arial", 9, PdfFontStyle.Regular)
brush = PdfSolidBrush(PdfRGBColor(0, 0, 0))
box_pen = PdfPen(PdfRGBColor(30, 144, 255))
header_brush = PdfSolidBrush(PdfRGBColor(220, 235, 255))
string_format = PdfStringFormat()
string_format.Alignment = PdfTextAlignment.Left

# Utility: Extract highlighted differences from each page
def extract_highlighted_text(page):
    highlights = []
    for annot in page.AnnotationsWidget:
        if annot.AnnotationType == "Highlight":
            try:
                txt = annot.Text
                if txt:
                    highlights.append(txt.strip())
            except:
                continue
    return highlights

# Loop through each page in CompareResult
for i in range(result_doc.Pages.Count):
    page = result_doc.Pages.get_Item(i)
    width = page.Canvas.ClientSize.Width

    # Extract highlighted differences for this page
    diff_texts = extract_highlighted_text(page)
    if diff_texts:
        content = "\n".join(f"- {t}" for t in diff_texts)
    else:
        content = "No differences detected on this page."

    # Define report box size
    box_height = 80
    box_rect = RectangleF(10, 10, width - 20, box_height)

    # Draw background box and border
    page.Canvas.DrawRectangle(header_brush, box_rect)
    page.Canvas.DrawRectangle(box_pen, box_rect)

    # Title text
    page.Canvas.DrawString(
        f"Page {i+1} – Difference Summary:",
        PdfTrueTypeFont("Arial", 10, PdfFontStyle.Bold),
        brush,
        PointF(15, 15)
    )

    # Difference content text
    page.Canvas.DrawString(
        content,
        font,
        brush,
        RectangleF(15, 30, width - 30, box_height - 20),
        string_format
    )

# Save enhanced output
final_path = os.path.join(output_dir, "CompareResult_withReportBox.pdf")
result_doc.SaveToFile(final_path)
result_doc.Dispose()

print(f"✅ Enhanced comparison report generated: {final_path}")
