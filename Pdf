import os
from spire.pdf import PdfDocument, PdfComparer, PdfBrushes, PdfTrueTypeFont, PdfSolidBrush, PdfStringFormat
from spire.pdf.graphics import PdfRGBColor, PdfPen, PdfFontStyle
from spire.pdf.common import RectangleF, PointF

# === Input paths ===
pdf_a_path = '20250918115113_Z0N613_E60043126_FNA.pdf'
pdf_b_path = '20250918115113_Z0N613_E60043126_FNA - Copy.pdf'

# === Output setup ===
output_dir = "output"
os.makedirs(output_dir, exist_ok=True)
compare_path = os.path.join(output_dir, "CompareResult.pdf")
final_path = os.path.join(output_dir, "CompareResult_withReportBox.pdf")

# === Step 1: Compare two PDFs ===
pdf_a = PdfDocument(pdf_a_path)
pdf_b = PdfDocument(pdf_b_path)

comparer = PdfComparer(pdf_a, pdf_b)
comparer.Compare(compare_path)

pdf_a.Dispose()
pdf_b.Dispose()

# === Step 2: Add difference summary boxes ===
result_doc = PdfDocument()
result_doc.LoadFromFile(compare_path)

# --- Styles ---
font = PdfTrueTypeFont("Arial", 9, PdfFontStyle.Regular)
title_font = PdfTrueTypeFont("Arial", 10, PdfFontStyle.Bold)
brush = PdfSolidBrush(PdfRGBColor(0, 0, 0))
header_brush = PdfSolidBrush(PdfRGBColor(220, 235, 255))
pen = PdfPen(PdfRGBColor(30, 144, 255))
string_format = PdfStringFormat()

# --- Extract highlighted annotation text ---
def extract_highlighted_text(page):
    highlights = []
    if page.AnnotationsWidget is not None:
        for annot in page.AnnotationsWidget:
            # AnnotationTypeName is safer in Spire-Python than AnnotationType
            if hasattr(annot, "AnnotationTypeName") and "Highlight" in annot.AnnotationTypeName:
                try:
                    txt = getattr(annot, "Text", None)
                    if txt:
                        highlights.append(txt.strip())
                except Exception:
                    continue
    return highlights

# --- Loop through each page ---
for i in range(result_doc.Pages.Count):
    page = result_doc.Pages.get_Item(i)
    width = page.Canvas.ClientSize.Width

    # Get difference text
    diff_texts = extract_highlighted_text(page)
    if diff_texts:
        content = "\n".join(f"- {t}" for t in diff_texts)
    else:
        content = "No differences detected on this page."

    # Draw the light-blue box
    box_height = 80
    rect = RectangleF(10, 10, width - 20, box_height)
    page.Canvas.DrawRectangle(header_brush, rect)
    page.Canvas.DrawRectangle(pen, rect)

    # Title
    page.Canvas.DrawString(
        f"Page {i+1} – Difference Summary:",
        title_font,
        brush,
        PointF(15, 15)
    )

    # Content
    page.Canvas.DrawString(
        content,
        font,
        brush,
        RectangleF(15, 30, width - 30, box_height - 20),
        string_format
    )

# === Save result ===
result_doc.SaveToFile(final_path)
result_doc.Dispose()

print(f"✅ Enhanced comparison report generated successfully: {final_path}")
